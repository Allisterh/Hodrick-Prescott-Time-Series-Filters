# Hodrick - Prescott Filter for univariate time series

# Written by: Jorge Paredes on May, 2022.

# Inspired by the first problem set of intermediate macroeconomics lectured at USFQ by Carlos Uribe

# Preamble ----
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(lubridate)
library(data.table)
library(zoo)
library(gridExtra)

home <- "C:/Users/jparedesm/iCloudDrive/Desktop/Papers/Time Series/Univariate/Hodrick Prescott/Data"
setwd(home)

options(scipen=999)

# Data ----

# I used the Real Gross Domestic Product for the U.S. Billions of Chained 2012 Dollars, Seasonally Adjusted Annual Rate
# Data is retrieved from FRED St. Louis: https://fred.stlouisfed.org/series/GDPC1 

gdp <- read_csv("GDPC1.csv") %>% 
  rename(gdp=GDPC1, date=DATE) %>% 
  mutate(date=as.Date(date),
         `Gross Domestic Product`=log(gdp))


# Compute the Hodrick - Prescott filter as a function
hp_filter <- function(data, lambda, var_name, type="additive", show_F=FALSE){
  # Arrange the data ----
  data <- as.data.frame(data)
  date <- data %>% select_if(is.Date)
  
  y <- data %>% select({{var_name}})
  y <- y[[1]]
  
  # Compute the F matrix ----
  n <- nrow(data)
  row_1 <- c(1,-2,1, rep(0, each=(n-3)))
  row_2 <- c(-2,5,-4,1, rep(0, each=(n-4)))
  
  intermediate_rows <- list()
  for(i in 3:(n-2)){
    before <- abs(3-i)
    after <- n-length(c(rep(0, each=before), c(1,-4,6,-4,1)))
    row <- c(rep(0, each=before), c(1,-4,6,-4,1), rep(0, each=after))
    intermediate_rows[[i]] <- t(row)
  }
  intermediate_rows <- intermediate_rows[!sapply(intermediate_rows, is.null)]
  intermediate_rows <- as.matrix(do.call(rbind, intermediate_rows))
  
  row_n_1 <- c(rep(0, each=(n-4)), 1,-4, 5,-2)
  row_n <- c(rep(0, each=(n-3)), 1,-2,1)
  
  F_ <- rbind(row_1, row_2, intermediate_rows, row_n_1, row_n)
  rownames(F_) <- NULL
  
  # Compute the lambda * F matrix ----
  LF_=lambda*F_
  
  # Compute the I matrix ----
  I <- diag(n)
  
  # Compute the (I+LF)^-1 matrix ---
  A <- (I+LF_)
  A <- solve(A)
  
  # Compute the (I+LF)^-1 * y  (this is the trend component)----
  trend <- A %*% y
  # Compute the cycle -----
  if(type=="additive"){
    # y= t+c -> c=y-t
    cycle <- y-trend
  }else{
    # multiplicative: y=t*c -> c=y/t
    cycle <- y/t
  }
  # Pack everything into a data.frame ----
  variable <- deparse(substitute(var_name))
  
  trend_name <- paste("Trend",variable)
  
  cycle_name <- paste("Cycle",variable)
  
  result <- data.frame(date=date,
                       variable=y,
                       trend=trend, 
                       cycle=cycle)
  
  if(type=="additive"){
    type_ <- "Additive |  y=t+c"
  }else{
    type_ <- "Multiplicative |  y=t*c"
  }
  
  cat(paste(" Hoddrick - Prescott Filter \n -------------------------\n", 
            "Variable:", variable, "\n",
            "Î» =", lambda, "\n",
            "Series Type:", type_, "\n\n"))
  
  if(show_F==TRUE){
    print(F_)
  }
  
  
  return(result)
  
}


# Example on how to use it 
gdp7 <- filter(gdp, row_number()<=7)
hp_filter(data= gdp7, lambda = 1600, var_name = `Gross Domestic Product`, show_F = TRUE)

# EOF - Jorge
